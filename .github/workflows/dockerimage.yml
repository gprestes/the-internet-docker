name: Docker Image CI

on: [push]

jobs:
  hadolint:
    runs-on: ubuntu-20.04
    steps:
      - uses: actions/checkout@v3.0.2
      - run: make lint-docker
  shellcheck:
    runs-on: ubuntu-20.04
    steps:
      - uses: actions/checkout@v3.0.2
      - run: make lint-shell
  terratest:
    needs: [hadolint, shellcheck]
    runs-on: ubuntu-20.04
    steps:
      - uses: actions/checkout@v3.0.2
      - name: Set up go
        uses: actions/setup-go@v3.2.0
        with:
          go-version: 1.16
      - name: Setup Dependencies
        working-directory: tests/
        run: go get -v -t -d && go mod tidy
      - name: Test
        working-directory: tests/
        run: go test -v
  build:
    needs: [terratest]
    runs-on: ubuntu-20.04
    steps:
      - uses: actions/checkout@v3.0.2
      - run: docker build . --file docker/Dockerfile --tag the-internet-docker:$(date +%s)
